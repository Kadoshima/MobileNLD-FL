# TODO List - BLE Adaptive Advertising Project

## 🎯 全体マイルストーン
- **M1** (Week1末): 固定広告と不確実度計算の動作確認
- **M2** (Week3中): 適応版安定動作、PPK2再現測定
- **M3** (Week4末): 被験者データ収集完了
- **M4** (Week5中): 解析完了、受け入れ基準達成
- **M5** (Week6末): 論文完成、再現パッケージ整備

## 🚨 NOW - 48時間以内着手

### [P0] 環境構築
- [ ] **nRF環境構築**
  - 選択: nRF5 SDK + SoftDevice S140
  - ✅完了条件: ADV_NONCONN_INDがスマホで受信確認

- [ ] **PPK2セットアップ**
  - 設定: Source 3.0V, 10ksps
  - ✅完了条件: 広告パルスが波形で可視

### [P0] 基盤実装
- [ ] **IMUドライバ実装**
  - 仕様: 50Hz, DMA, 2秒窓
  - ✅完了条件: UARTに1秒毎統計出力

- [ ] **HAR軽量モデル準備**
  - 仕様: 1D-CNN, INT8, <20KB
  - ✅完了条件: PC上でTFLM推論OK、精度≥96%

- [ ] **TFLM統合＋推論時間測定**
  - 目標: ≤5ms/ウィンドウ
  - ✅完了条件: UARTで推論ms表示

- [ ] **Androidロガー最小版**
  - 機能: フォアグラウンドサービス＋SCAN_MODE_LOW_LATENCY
  - ✅完了条件: CSVスキーマ準拠出力

## 📅 Week 1-2: 実装・統合

### Firmware [FW]
| Priority | Task | 依存 | 完了条件 |
|----------|------|------|----------|
| P0 | BLE動的間隔制御（50-2000ms） | BLEスタック | UARTコマンドで即時反映 |
| P0 | Manufacturer Data実装 | - | Androidでパース成功 |
| P0 | 不確実度計算＋温度スケーリング | TFLite | u_norm∈[0,1]をUART出力 |
| P0 | 適応ゲーティング（3状態制御） | 不確実度 | 状態遷移でΔt_adv変化 |
| P1 | TX出力制御 | - | Quiet:-4dBm, Active:0dBm |
| P1 | 同期フェーズ | - | 起動3秒は50ms広告 |

### Android App [APP]
| Priority | Task | 依存 | 完了条件 |
|----------|------|------|----------|
| P0 | CSVスキーマ準拠ログ出力 | - | JSONスキーマ検証OK |
| P0 | バックグラウンド対応 | - | 20分で受信率劣化<5% |
| P1 | リアルタイム可視化 | - | 受信率・RSSI表示 |
| P1 | 端末クロステスト | - | Pixel+他1機種OK |

### 計測・ベースライン [MEAS]
| Priority | Task | 依存 | 完了条件 |
|----------|------|------|----------|
| P0 | 固定広告測定 | PPK2 | 100/200/500ms各5分×3 |
| P1 | TX出力差分測定 | - | 0/-4/-8dBmの比較 |
| P0 | データ管理スクリプト | - | meta.json自動生成 |

## 📅 Week 3: チューニング

### 最適化 [OPT]
- [ ] **[P0] ヒステリシス調整**
  - パラメータ: min dwell 2s, EWMA α=0.2
  - ✅完了条件: 状態フラップ≤6回/分

- [ ] **[P0] しきい値スイープ**
  - 範囲: θ_q∈[0.2,0.4], θ_a∈[0.6,0.8]
  - ✅完了条件: パレート最適点特定

- [ ] **[P0] 遅延推定テスト**
  - 方法: STATE_CHANGEフラグ活用
  - ✅完了条件: p95≤300ms確認

- [ ] **[P1] GPIOトグル実装**
  - 用途: 状態遷移マーカー
  - ✅完了条件: PPK2波形で可視

- [ ] **[P1] 長時間動作テスト**
  - 期間: 2時間連続
  - ✅完了条件: メモリリーク/クラッシュなし

## 📅 Week 4: 本番データ収集

### 実験 [EXP]
- [ ] **[P0] 被験者募集**
  - 人数: 3-5名
  - ✅完了条件: 同意書取得完了

- [ ] **[P0] データ収集（ラテン方格）**
  - プロトコル: 各条件20分×4
  - ✅完了条件: 全runのトリプルログ取得

- [ ] **[P0] 距離テスト**
  - 条件: 1/3/5m（Adaptive）
  - ✅完了条件: 距離別欠落率記録

- [ ] **[P1] 品質チェック（QC）**
  - 内容: 欠落率・遅延・電流
  - ✅完了条件: 異常時即リトライ

- [ ] **[P1] 8時間連続運用テスト**
  - 条件: 1被験者、実環境
  - ✅完了条件: 安定動作確認

## 📅 Week 5: 解析・アブレーション

### 分析 [ANL]
- [ ] **[P0] 解析ノートブック作成**
  - 内容: summary_by_run/condition
  - ✅完了条件: 1コマンドで図表生成

- [ ] **[P0] 統計解析**
  - 手法: paired t-test, Cohen's d
  - ✅完了条件: p<0.05, d>0.8

- [ ] **[P0] 受け入れ基準判定**
  - 項目: 省電力≥40%, p95≤300ms, F1低下≤1.5pt, 欠落≤5%
  - ✅完了条件: 全項目PASS

- [ ] **[P1] アブレーション分析**
  - 対象: ヒステリシスON/OFF, TX制御ON/OFF
  - ✅完了条件: 各要素の寄与率算出

- [ ] **[P2] CCS拡張テスト**
  - 実装: Volatility追加（CCS=0.6U+0.4V）
  - ✅完了条件: +10%追加削減

## 📅 Week 6: 論文・公開

### 論文 [PAPER]
- [ ] **[P0] 原稿執筆**
  - 構成: 4ページ、図3表1
  - Abstract: 数値を1行目に
  - ✅完了条件: ComEX形式準拠

- [ ] **[P0] 図表作成**
  - Fig1: システム構成
  - Fig2: 電流トレース
  - Fig3: パレート曲線
  - Table1: 条件別指標
  - ✅完了条件: 300-600dpi、8-9pt可読

- [ ] **[P1] 内部レビュー**
  - 共著者確認
  - ✅完了条件: 最終承認

### 再現パッケージ [PKG]
- [ ] **[P0] リポジトリ整備**
  - 構成: firmware/, android/, analysis/, data/sample/
  - ✅完了条件: README完備

- [ ] **[P1] サンプルデータ**
  - 内容: 小規模テストデータ
  - ✅完了条件: notebook再現可能

## 🔍 品質ゲート (Definition of Done)

### Firmware DoD
✅ Δt_advとTX電力の動的制御が整合  
✅ 状態フラップ≤6回/分  
✅ 8時間連続動作OK

### Android Logger DoD
✅ JSONスキーマ検証合格  
✅ バックグラウンドで受信率劣化<5%  
✅ 2機種で同等動作

### Measurement DoD
✅ E_advがΔt_advに比例  
✅ 遅延推定が安定  
✅ 再現性確認

### Analysis DoD
✅ 受け入れ基準を満たす  
✅ 統計的有意差（p<0.05）  
✅ 1コマンドで図表生成

### Paper DoD
✅ 4ページ内収束  
✅ 主要数値が明記  
✅ 図表とテキストの整合

## 🚨 リスク対応策

### IF: 省電力率<40%
- [P0] θ再最適化（Quiet滞在増加）
- [P0] 最小Δt_adv: 100→200ms
- [P1] TX: -4→-8dBm

### IF: 遅延>300ms
- [P0] Active即100ms化
- [P0] レート制限: 2s→1s
- [P1] STATE_CHANGEバースト追加

### IF: 欠落率>5%
- [P0] 最小Δt_adv: 50→100ms
- [P0] TX出力0dBm固定
- [P1] 端末・配置最適化

## 📊 進捗トラッキング

### クリティカルパス
```
環境構築 → FW基盤 → 統合テスト → データ収集 → 解析 → 論文
  2日      1週間     3日        1週間      3日    1週間
```

### 工数見積
- FW: 1.5週
- APP: 0.8週
- 測定: 1.0週
- 解析: 0.8週
- 論文: 1.0週
- バッファ: 0.9週

---
*優先度: P0=必須, P1=強推奨, P2=余裕があれば*  
*期間: 6週間スプリント*  
*Last Updated: 2024-12-17*