# 研究概要: Context-Uncertainty-Driven Adaptive BLE Advertising for Ultra-Low-Power Wearable HAR

## 1. 研究背景と目的

### 1.1 背景
ウェアラブルデバイスにおける継続的な活動認識（HAR: Human Activity Recognition）と通信のために、BLE（Bluetooth Low Energy）広告が広く使用されている。しかし、固定間隔での継続的なBLE広告は、デバイスのバッテリー寿命を大幅に短縮させる主要因となっている。特に小型ウェアラブルデバイスでは、限られたバッテリー容量（例：135mAh）での長時間動作が重要な課題である。

### 1.2 研究目的
本研究は、HAR（人間活動認識）の不確実度に基づいてBLE広告間隔を動的に調整することで、ウェアラブルデバイスの消費電力を大幅に削減することを目的とする。具体的には：
- 固定100ms間隔比で**30-40%以上の消費電力削減**（ESP32推定値、相対比較）
- **p95遅延300ms以下**を維持
- **パケット損失率5%以下**（屋内5m範囲、干渉軽微環境）
- **F1スコアの低下を1.5ポイント以内**に抑制

## 2. 提案手法

### 2.1 コアイノベーション
**不確実度駆動型適応制御（Uncertainty-Driven Adaptive Control）**
- 分類不確実度（Classification Uncertainty）と時間的ボラティリティ（Temporal Volatility）の複合スコアを使用
- リアルタイムでコンテキストを評価し、BLE広告間隔を3段階で制御
- **重要**: 非接続型BLE広告（ADV_NONCONN_IND）を採用し、広告パケット自体にHARデータを埋め込む方式

### 2.2 適応制御アルゴリズム（3状態機械）
```
状態定義:
- Quiet状態: Δt_adv = 2000ms（低電力モード）
- Uncertain状態: Δt_adv = 500ms（中間モード）  
- Active状態: Δt_adv = 100ms（高レスポンスモード）

状態遷移条件（EWMA使用）:
- EWMA更新: m_t = α·u_t + (1-α)·m_{t-1}（α=0.2）
- Quietエントリ: m_t < θ_q_in（0.25）かつ活動スコア低
- Activeエントリ: m_t > θ_a_in（0.60）
- Uncertain: 上記以外

ヒステリシス（状態維持）:
- Quiet維持: m_t < θ_q_out（0.30）
- Active維持: m_t > θ_a_out（0.55）

制約:
- レート制限: 前回変更から2秒未満は変更しない
- バッテリーセーフガード: battery<10% → Δt_adv=5000ms固定
```

### 2.3 複合コンテキストスコア
```
Context Score = α × Classification_Uncertainty + β × Temporal_Volatility
- Classification_Uncertainty: HARモデルの出力エントロピー
- Temporal_Volatility: 時間窓内の活動変化率
- α, β: 重み係数（実験的に最適化）
```

### 2.4 BLE通信方式の設計判断
**非接続型広告（ADV_NONCONN_IND）を採用する理由**：
1. **省電力最適化**: 接続確立・維持のオーバーヘッドを回避
2. **一方向ブロードキャスト**: Legacy Advertising（31バイト）にデータ埋め込み
3. **接続後の動作**: BLE仕様により接続時は広告が自動停止するため、本研究では接続を避ける設計

**広告データ形式（Manufacturer Specific Data: 12-16バイト）**：
- Company ID（2バイト）: 0xFFFF（テスト用）
- Protocol Version（1バイト）: 0x01
- Device Session ID（2バイト）: 毎起動ランダム生成
- Activity Level（1バイト）: 0=Quiet, 1=Active, 2=Uncertain  
- Uncertainty u（1バイト）: 0-255（エントロピー量子化）
- Battery Level（1バイト）: 0-100%
- Timestamp LSB（2バイト）: 100ms単位のモジュロカウンタ
- Reserved（1-4バイト）: 拡張用

**接続型との比較**：
- 接続型（GATT）: Connection Interval（7.5ms〜4s）での定期通信、双方向、高信頼性、高電力
- 非接続型（本研究）: 広告間隔（100ms〜2000ms）での一方向送信、低電力、パケット損失許容

## 3. システムアーキテクチャ

### 3.1 ハードウェア構成（PIVOT版）
```
[M5StickC Plus2 ×3台] - ウェアラブルデバイス
├─ ESP32-PICO-V3-02 MCU (240MHz, 520KB RAM)
├─ MPU6886 6軸IMU (加速度±8g, ジャイロ±2000dps)
├─ AXP192電源管理IC (電流測定機能内蔵、精度±5mA)
├─ 135mAhバッテリー
├─ オンデバイスHAR推論
├─ 不確実度計算
└─ 適応的BLE広告

[スマートフォン] - 受信・記録デバイス（Galaxy S9メイン）
├─ BLEパケット受信（BluetoothLeScanner）
├─ タイムスタンプ記録（ms精度）
├─ CSVエクスポート
└─ リアルタイムモニタリング

マルチデバイス構成（オプション）:
├─ 1台: マスターHAR + 適応広告
└─ 2台: スレーブ同期テスト（冗長性検証）
```

### 3.2 ソフトウェアスタック
- **ファームウェア**: Arduino IDE（ESP32 Core 2.0.14）
- **HARモデル**: TensorFlow Lite Micro（2クラス: Active/Idle）
- **モデルサイズ**: <20KB（量子化済み）
- **推論頻度**: 10Hz（100ms間隔）
- **モバイルアプリ**: 
  - Android: nRF Connect / カスタムロガー（Kotlin）
  - iOS: nRF Connect / Swift+CoreBluetooth
- **解析環境**: Python 3.9+, pandas, matplotlib, scipy

## 4. 実験設計

### 4.1 実験条件
| 条件 | BLE広告間隔 | 用途 |
|------|------------|------|
| Fixed-100ms | 100ms固定 | ベースライン（最高性能） |
| Fixed-200ms | 200ms固定 | 中間比較 |
| Fixed-500ms | 500ms固定 | 省電力比較 |
| Adaptive | 100-2000ms動的 | 提案手法 |

### 4.2 実験プロトコル
1. **被験者**: 3-5名（S01-S05）
2. **活動シナリオ**:
   - 静坐30分、歩行30分
   - デスクワーク60分、階段/家事30分
   - 休憩30分（合計~3時間/人）
3. **測定期間**: 各設定15分×条件（合計≥3時間/人）
4. **デバイス配置**: 腰部装着（ベルトクリップ）
5. **同期手法**: イベントマーカー（状態遷移時LED点滅→ログ同期）
6. **3台同時測定**: マルチデバイス同期テスト（オプション）

### 4.3 評価指標（優先順位）
1. **平均消費電流削減率**: ≥30-40%（対Fixed-100ms、ESP32推定値）
   - AXP192内蔵測定@1Hz（精度±5mA）
   - 平均消費電流 I_avg [µA]、エネルギー/分 E_min [mJ/min]
2. **p95通知遅延**: ≤300ms（広告受信ベース）
   - 広告生成時刻（推定）→受信記録の差分
   - p50/p95を算出
3. **HAR F1スコア**: 低下≤1.5ポイント
   - マクロF1、粗カテゴリ（Quiet/Active）
4. **パケット欠落率**: ≤5%（屋内5m範囲、干渉軽微環境）
   - 生成推定パケット数に対する受信数の不足割合

## 5. 現在の進捗状況

### 5.1 Phase 1: 実現可能性検証（2024年12月17日〜）
- ✅ M5StickC Plus2環境構築完了
- ✅ 固定100ms BLE広告実装
- ✅ Python解析環境構築
- ✅ UCI HARデータセット準備
- 🔄 IMUデータ収集実装中（MPU6886）
- ⏳ AXP192電力測定実装
- ⏳ 適応制御アルゴリズム実装
- ⏳ スマートフォンロガー開発

### 5.2 タイムライン（6週間）
**Week 1**: 環境構築
- ESP-IDF/Arduino環境セットアップ
- 固定広告動作（100ms）

**Week 2**: HARモデル実装
- TensorFlow Lite Micro実装
- 量子化（int8）・推論測定

**Week 3**: 適応制御実装
- 不確実度計算
- 適応ロジック（EWMA、3状態機械）
- 設定インターフェース

**Week 4**: 計測系準備
- AXP192ログシステム
- 校正・しきい値探索（θ_q_in=0.25, θ_a_in=0.60）

**Week 5**: 被験者実験
- データ収集（3-5名）
- 各条件15分×複数セッション

**Week 6**: 解析・論文執筆  
- 統計解析（対応のあるt検定、p<0.05）
- 図表作成（パレート曲線等）
- ComEX投稿準備（4ページ）

## 6. 期待される成果とインパクト

### 6.1 技術的貢献
- **新規性**: 不確実度に基づく適応的BLE広告制御の初の実装
- **実用性**: 実機での電力削減効果を実証（30%以上）
- **汎用性**: 他のウェアラブルシステムへの応用可能

### 6.2 学術的貢献
- IEICE Communications Express（ComEX）への投稿（2025年目標）
- オープンソース実装の公開
- 再現可能な実験プロトコルの確立

### 6.3 社会的インパクト
- ウェアラブルデバイスのバッテリー寿命延長
- 継続的健康モニタリングの実現性向上
- IoTデバイスの省電力化への貢献

## 7. 関連研究との差別化

### 7.1 既存研究の限界
- **固定間隔BLE**: 電力効率が悪い
- **単純な適応制御**: コンテキスト認識が不十分
- **シミュレーションベース**: 実機検証が不足

### 7.2 本研究の優位性
- **不確実度ベース**: HARの信頼度を直接活用
- **複合メトリクス**: 分類と時間的変化の両方を考慮
- **実機検証**: M5StickC Plus2での実測定

## 8. リスクと対策

### 8.1 技術的リスク
| リスク | 影響 | 対策 |
|--------|------|------|
| ESP32の電力効率 | 目標未達 | 30%目標に調整済み |
| BLEスタック制限 | 遅延増大 | 最小100ms間隔を維持 |
| IMU精度 | HAR性能低下 | 2クラス簡略化 |

### 8.2 実験的リスク
- **被験者不足**: 最小3名で統計的検証
- **環境干渉**: 2.4GHz帯の混雑→時間帯調整
- **デバイス故障**: 3台体制でバックアップ

## 9. データ管理とガバナンス

### 9.1 データ整合性
- **Append-only**: 生データは不変
- **SHA256チェックサム**: 全ファイルで生成
- **二重バックアップ**: ローカル+クラウド

### 9.2 実験プロトコル
- Run ID体系: `YYYYMMDD_HHMMSSZ_{subject}_{condition}_{seq}`
- メタデータ必須項目: デバイスID、閾値、コミットハッシュ
- 品質管理: パケット損失<10%、p95間隔<2×設定値

## 10. 成功基準とKPI

### 10.1 必須達成項目（受け入れ基準）
- ☐ 平均消費電流削減率≥30%（固定100ms比）かつ統計的有意性あり（p<0.05）
- ☐ p95遅延≤300ms（広告受信ベース）
- ☐ パケット欠落率≤5%（屋内5m範囲、干渉軽微環境）
- ☐ F1低下≤1.5ポイント（同一データ・プロトコル）
- ☐ 1時間連続動作でハング/クラッシュなし

### 10.2 論文投稿要件
- ☐ 3名以上の被験者データ
- ☐ 各条件20分以上の測定
- ☐ 統計的有意差（p<0.05）
- ☐ 再現可能な実装

## 11. リソースと体制

### 11.1 ハードウェアリソース
- M5StickC Plus2: 3台（購入済み）
- iPhone 13/15: 実験用
- Galaxy S9: メイン受信機
- MacBook: 開発・解析環境

### 11.2 ソフトウェアライセンス
- Arduino IDE: オープンソース
- TensorFlow Lite Micro: Apache 2.0
- Python解析ツール: オープンソース

## 12. 参考文献（主要）
1. BLE省電力化技術の関連研究
2. HAR不確実性定量化手法
3. 適応的通信プロトコル
4. コンテキストアウェアシステム

---

**プロジェクトステータス**: Phase 1 実装中  
**最終更新**: 2024年12月17日  
**目標投稿先**: IEICE Communications Express (2025)  
**リポジトリ**: MobileNLD-FL  
**ガバナンス**: 厳格なAppend-onlyデータポリシー適用中