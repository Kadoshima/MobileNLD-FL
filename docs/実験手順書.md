実験手順書（Version 1.0）
プロジェクト名：Context-Uncertainty–Driven Adaptive BLE Advertising for Ultra-Low-Power Wearable HAR

0. 文書情報
- 目的：研究要件に基づき、実装検証・測定・解析までの実験手順を標準化する
- 作成日：2025-08-17
- 想定読者：実験実施者（研究者・学生）、指導者、共同著者
- 参照：要件定義書 v1.0

1. 実験の目的と評価項目
- 目的：HARの不確実度に応じてBLE広告間隔を自律可変させ、通信エネルギーを削減しつつ検出遅延・精度の劣化を最小化できることを実機で示す
- 主評価指標
  - 平均消費電流 I_avg [µA]、エネルギー/分 E_min [mJ/min]
  - HAR精度（粗カテゴリ：静穏/活動）マクロF1
  - 通知遅延 p50/p95 [ms]
  - パケット欠落率 [%]
- 成功基準（受け入れ基準の要約）
  - I_avg 削減率 >= 40%（固定100ms比）、p<0.05
  - F1 低下 <= 1.5 ポイント
  - p95 遅延 <= 300 ms、欠落率 <= 5%
  - 連続8時間動作でハングなし

2. 必要物品・機材
- センサ側
  - nRF52840 DK（または nRF52832 DK）
  - IMU（LSM6DS3/MPU-6050 等、I2C接続）
  - USBケーブル（データ・電源）
  - 取付用バンドまたはケース（手首/腰）
- 計測系
  - Nordic Power Profiler Kit II（PPK2）または 10Ωシャント＋オシロ
  - PC（開発・ログ収集・解析）
- 受信側
  - Androidスマホ（Android 10+、BLE5対応、例：Pixel 6）
  - BLEスキャン用アプリ（自作ロガー）
- 付帯
  - メジャー（距離管理）、腕時計タイマ、同意書
  - 安全ピン／ベルクロバンド（装着安定）
  - ステッカー等（姿勢・タスク切替の目印）

3. 事前準備（T-3〜T-1日）
3.1 ファームウェア準備
- 要件定義書の仕様に合わせてビルド
  - IMU: 50 Hz、2.0 sウィンドウ/0.5 sストライド
  - 1D-CNN int8（<20 KB）
  - 不確実度：エントロピー正規化 u∈[0,1]
  - 適応ロジック：Quiet/Uncertain/Active 3状態＋EWMA＋ヒステリシス
  - BLE：ADV_NONCONN_IND、Δt_adv 可変（50–2000 ms）
  - 広告ペイロード（Manufacturer Data）：
    - CompanyID(2), Ver(1), SessionID(2), State(1), u_q(1), Battery(1), Seq(1), TickLSB(2), Flags(1)
- UARTコマンド（初期設定変更・ダンプ）を有効化
- LED同期パターン実装（開始合図用：200 ms×3回点灯）

3.2 Androidロガー準備
- フォアグラウンドサービス化（常時スキャン維持）
- ScanSettings: SCAN_MODE_LOW_LATENCY、フィルタ＝CompanyID
- ログCSV項目
  - recv_unix_ms, recv_elapsed_ns, device_id, rssi_dbm, mfg_raw_hex, seq, tick_lsb_10ms, state, u_q_0_255, battery_pct, scan_callback_dropped
- 端末時刻のNTP同期（自動/手動）

3.3 PPK2準備
- Sourceモード（3.0V、上限電流十分に）、サンプリング 10 ksps
- CSV保存を有効化、測定前にゼロ点調整
- 「マーカー」機能または開始時刻記録のメモ準備

3.4 データ管理
- フォルダ構成
  - data/raw/{YYYYMMDD}/{subject_id}/{condition}/
    - ppk2_{run_id}.csv
    - phone_{run_id}.csv
    - uart_{run_id}.log
    - meta_{run_id}.json（設定と環境）
- 被験者ID付与、同意取得（匿名化）

4. 実験設計と試験条件
4.1 条件（最低実施）
- Baseline-F100：固定広告間隔 100 ms
- Baseline-F200：固定 200 ms
- Baseline-F500：固定 500 ms
- Proposed-ADP：適応（θ_q_in=0.25, θ_q_out=0.30, θ_a_out=0.55, θ_a_in=0.60, α=0.2, レート制限2 s）
- 予備：Proposed-ADP-HighHyst（ヒステリシス強化）［任意］

4.2 タスクシナリオ（各条件 20 分）
- 0–2分：静止立位（Quiet）
- 2–6分：歩行（Active）
- 6–8分：静座（Quiet）
- 8–12分：階段または屈伸（Active）
- 12–14分：静座（Quiet）
- 14–18分：家事動作（拭き掃除等、Active）
- 18–20分：静止立位（Quiet）
- 各条件の順序は被験者ごとにランダム化（ラテン方格）して順序効果を除去

4.3 距離・環境
- 室内オフィス、LOSでスマホとの距離 3 m（基準）
- 距離試験：1 m / 5 m でも各5分ずつ実施（Proposed-ADPのみ）
- 干渉：Wi-Fi/BLE混雑が中程度の時間帯を選定、SSID数を記録

4.4 被験者数と反復
- 被験者 3–5 名
- 各条件 1 回（20 分）× 各被験者（最低）
- 追加で別日リピート 1 回（代表被験者1名）［推奨］

5. 共通測定手順（1ラン実行の基本フロー）
- ステップ0：安全・倫理
  - 被験者に内容説明、同意書署名、装着確認（きつ過ぎない）
- ステップ1：初期化
  - PC、PPK2、スマホ時刻をNTP同期
  - nRF DK を PPK2 経由で給電、UART接続
  - Android ロガー起動（まだスキャン開始しない）
- ステップ2：メタ情報記録
  - meta_{run_id}.json に以下を記録
    - subject_id, date_time, room, distance_m, phone_model, firmware_hash, condition, thresholds, tx_power_dbm, phy, imu_fs, notes
- ステップ3：同期シーケンス
  - デバイスをリセット→LED 200ms×3回点灯（PPK2に明瞭な電流段差）
  - 直後3秒間、Δt_adv=50 msでSYNC広告（seq 0..60、tickを10ms単位）
  - Androidロガーで「開始」→最初のSYNC広告受信時刻をT0_phoneと記録
  - UARTログに「RUN_START, run_id, condition」を記録
- ステップ4：本測定
  - 条件に応じて Δt_adv を設定（固定 or 適応）
  - 被験者にタスクシナリオ開始を伝える（音声カウント/タイマ）
  - スマホはポケット or 机上で位置固定、画面ONのまま
  - 20分間、PPK2計測・スマホスキャン・UARTログを継続
- ステップ5：終了
  - ロガー「停止」、PPK2保存、UARTログ保存
  - ファイルを data/raw/... に即時コピー、チェックサム（md5）作成
  - 被験者の状態確認・休憩

6. ベースライン条件の詳細手順（F100/F200/F500）
- ファーム側で適応ロジックを無効化、Δt_adv を固定
- 上記「共通測定手順」を実施
- それぞれ 20 分×被験者分
- メモ：パケット欠落率が 5% を超えた場合は距離/向きを微調整し再試行

7. 提案方式（ADP）の詳細手順
- 適応ロジック有効化、しきい値初期値（θ_q_in=0.25, θ_a_in=0.60 等）
- UARTで現在設定をダンプ（記録保全）
- 「共通測定手順」を実施
- 追加テスト（任意）
  - ヒステリシス強化：θ_q_out=0.35, θ_a_out=0.50 に変更して 10 分測定
  - 最小Δt_adv=100 ms と 50 ms の比較（Android機種によっては 50 ms 受信低下）

8. 距離・干渉テスト（Proposed-ADP）
- 距離 1 m、5 m に設定し、それぞれ 5 分測定
- 途中で人体遮蔽（スマホを反対側のポケットに移す）を1分導入
- RSSI の中央値と欠落率を記録し、基準条件（3 m LOS）と比較

9. 長時間連続動作テスト（信頼性）
- 条件：Proposed-ADP、距離 3 m、屋内
- 連続 8 時間（可能なら 12 時間）
- ログローテーション（1時間ごとにrun_id切替）でファイル肥大化回避
- 目的：クラッシュ・メモリリーク・フラッピングの有無確認

10. データ整合と品質チェック
- 収集直後に以下を確認
  - PPK2 CSV：総サンプル数、平均電流が0でない、開始直後にLEDシグネチャのステップが見える
  - Phone CSV：1分あたりの広告受信数が0になっていない、seqの単調増加に大きな飛びがない
  - UART：RUN_START/ENDが含まれる、状態遷移ログがある
- 欠測時の対処
  - スキャンドロップ >10%：アプリのフォアグラウンド維持、不要アプリ停止、端末再起動
  - PPK2オーバーレンジ：TX出力を下げるかPPK2電流上限を上げる

11. 時刻合わせと遅延推定の方法
- セッション開始時のSYNC広告でオフセット推定
  - 最初に受信したSYNC広告の phone 時刻を T0_phone、広告の tick を t0_tick とする
  - オフセット offset ≈ T0_phone − (t0_tick×10 ms)
- 状態遷移検出遅延
  - デバイス側で状態遷移時に「state_seq」をインクリメントし、次の広告に埋め込む
  - その広告の受信時刻 T_rx と、広告内の state_change_tick を用い
    - delay ≈ T_rx − (state_change_tick×10 ms) − offset
  - p50/p95 を状態遷移イベントごとに集計
- 備考：この方法は絶対時刻同期ではないため±1広告周期程度の誤差は許容

12. 指標算出と解析手順（Python想定）
- 前処理
  - PPK2：電圧列Vと電流列Iから I_avg = mean(I)、E_min = mean(I)×mean(V)×60
  - Phone：seq のギャップから欠落推定、rssiの外れ値除去（<−100 dBmは除外）
  - UART：状態遷移タイムスタンプ・state_seq を抽出
- HAR精度
  - ラベルはタスクスケジュールの区間を粗カテゴリにマッピング（静穏/活動）
  - ウィンドウ中心時刻で予測と区間ラベルを付き合わせ、マクロF1算出
- 欠落率
  - 期待パケット数 N_expect ≈ 実効 Δt_adv の逆数から推定（区間ごとに）
  - 欠落率 = 1 − N_recv / N_expect
- 遅延
  - 11章の式で遅延をイベントごとに推定し、p50/p95を条件別に算出
- 統計
  - 提案方式 vs 固定100ms の I_avg と遅延について、被験者内対応 t 検定（α=0.05）
  - 効果量（Cohen’s d）を併記
- 可視化（論文図の原型）
  - 図：消費電流の時系列（Quiet/Active 区間のアノテーション）
  - 図：Energy–Latency–F1 パレート散布
  - 表：条件別 I_avg、p95、欠落率、F1（平均±SD）

13. トラブルシュート
- 受信数が極端に少ない
  - スマホのスキャンモードが低電力になっていないか、フィルタ漏れがないか確認
  - Δt_adv が 50 ms のときに逆に欠落増 → 100 ms 以上に引き上げ
- 電流波形がフラット
  - PPK2のソース/メジャーモード誤設定、配線不良、DKの電源スイッチ
- 適応がフラッピング
  - ヒステリシス幅を広げる、EWMA α を 0.1〜0.2 に下げる、レート制限を3 sに
- HAR精度が低い
  - IMU取り付けの向き・ガタを見直し、前処理（バンドパス）のカットオフ調整

14. 倫理・安全
- 被験者に事前説明・同意取得、自由撤回の明示
- 階段・屈伸は体調に応じて無理なく、安全監督者1名配置
- 個人識別情報を収集しない、データは匿名IDで保存

15. 実験終了後のデータパッケージング
- 各 run の raw データと meta をセットで保管
- 解析スクリプト（commit hash付き）を data/analysis に配置
- README（再現手順）を同梱、ライセンス表記（学術利用）

16. 合否判定フロー（実施後）
- 各被験者について I_avg 削減率>=40% を満たすか確認
- 全被験者の平均で F1 低下<=1.5 pt、p95<=300 ms、欠落率<=5% を満たす
- 満たさない場合の対処優先順位
  1) Δt_advの下限を100 msに固定して再試行
  2) ヒステリシス強化・レート制限延長
  3) スマホのスキャン設定と機種変更（Pixel系推奨）

17. チェックリスト（印刷して現場で使用）
- 準備
  - [ ] ファーム書き込み（バージョン/ハッシュ記録）
  - [ ] Androidロガー（フォアグラウンド通知表示）
  - [ ] PPK2 サンプリング 10 ksps、電圧3.0V
  - [ ] NTP 同期済み（PC/スマホ）
  - [ ] 同意書取得、被験者ID付与
- 開始
  - [ ] meta_{run_id}.json 作成
  - [ ] LED 3フラッシュ確認、SYNC広告受信確認
  - [ ] PPK2/Phone/UART ログ開始
- 実施
  - [ ] 距離・環境条件メモ
  - [ ] タスク切替の合図・実施
  - [ ] 異常（欠落増/クラッシュ）発生メモ
- 終了
  - [ ] ログ停止・保存・ファイル名確認
  - [ ] データ整合クイックチェック
  - [ ] バックアップ（クラウド/外付け）
  - [ ] 被験者の体調確認

18. 付録：UARTコマンド例（例示）
- GET_CFG → 現在設定ダンプ（θ、α、Δt_adv min/max、TX出力）
- SET_TH x y z w → しきい値セット
- SET_ALPHA a → EWMA 係数
- SET_ADV_MINMAX m n → 広告間隔下限/上限
- SET_TX p → 送信出力（dBm）
- DUMP_STATE → 現在状態・u・Δt_adv・battery 出力
- SAVE_CFG → 不揮発保存

19. スケジュール（当日運用の目安）
- 準備 30 分 → ベースライン×3 条件（各20分＋切替5分） ≈ 75 分
- 休憩 15 分 → 提案方式 20 分 → 距離テスト 10 分×2
- 合計 ≈ 3 時間/被験者（余裕含む）

以上。  
必要に応じて、解析用ノートブックの雛形（入出力・図表テンプレ）や、AndroidロガーのCSVスキーマ定義の実ファイルを追補します。