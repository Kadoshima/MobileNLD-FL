# Phase 1 詳細実験手順書

## 📋 事前準備チェックリスト

### 必要機材
- [ ] M5StickC Plus2（最低1台、理想3台）
- [ ] USB-Cケーブル（データ転送対応）
- [ ] PC（Arduino IDE インストール済み）
- [ ] スマートフォン（iPhone or Android）
- [ ] nRF Connect アプリ（インストール済み）
- [ ] ストップウォッチ or タイマー

### Arduino IDE設定確認
- [ ] ボード: M5StickC Plus2 選択済み
- [ ] ポート: 適切なCOMポート選択済み
- [ ] シリアルモニタ: 115200 baud設定

---

## 📝 実験記録シート

### 基本情報
| 項目 | 記録値 |
|------|--------|
| 実験日時 | 2024-12-_____ ___:___ |
| 実験者名 | |
| 室温 | ___℃ |
| M5StickC ID | #1 / #2 / #3 |
| 初期バッテリー | ___% |

---

## 🔬 実験1: BLE固定広告テスト（15分）

### 手順
1. **ファームウェア書き込み**
   ```
   ファイル: firmware/m5stick/ble_fixed_100ms/ble_fixed_100ms.ino
   ```
   - Arduino IDEで開く
   - M5StickC Plus2を接続
   - 「→」ボタンでアップロード
   - アップロード完了メッセージ確認

2. **動作確認**
   - M5StickCのディスプレイ確認
     - 表示: "BLE Test" / "Fixed 100ms"
   - シリアルモニタ確認
     - メッセージ: "BLE Advertising started!"

3. **スマートフォンで受信確認**
   - nRF Connectアプリ起動
   - SCAN開始
   - "M5HAR_01"を探す
   - デバイスをタップして詳細表示

### 記録項目
| チェック項目 | 結果 | 値 |
|------------|------|-----|
| デバイス名表示 | □ OK / □ NG | M5HAR_01 |
| RSSI値 | | _____ dBm |
| Company ID | □ 確認 | 0x_____ |
| 広告間隔（目視） | | _____ ms |
| パケットカウント（1分） | | _____ packets |
| シーケンス番号増加 | □ OK / □ NG | |

### トラブルシューティング
- デバイスが見えない → Bluetoothオン確認、アプリ再起動
- 広告間隔が不安定 → USB給電で再テスト

---

## 🔬 実験2: IMUデータ取得テスト（20分）

### 手順
1. **ファームウェア書き込み**
   ```
   ファイル: firmware/m5stick/imu_har_test/imu_har_test.ino
   ```
   - 同様にアップロード

2. **キャリブレーション**
   - M5StickCを平らな場所に静置（10秒）
   - ディスプレイ確認: "HAR Test"表示

3. **動作テストシーケンス**
   
   **A. 静止テスト（1分）**
   - デバイスを机に置く
   - 状態とuncertainty値を記録
   
   **B. 歩行テスト（1分）**
   - デバイスを手に持って普通に歩く
   - 状態変化を観察
   
   **C. 遷移テスト（2分）**
   - 静止→ゆっくり動かす→静止
   - UNCERTAIN状態の出現を確認
   
   **D. 激しい動きテスト（30秒）**
   - 素早く振る
   - 最大uncertainty値を記録

### 記録項目

#### 状態遷移記録
| 時刻 | 動作 | 表示状態 | Uncertainty | 加速度値 |
|------|------|---------|-------------|----------|
| 0:00 | 静止開始 | | | |
| 0:30 | | | | |
| 1:00 | 歩行開始 | | | |
| 1:30 | | | | |
| 2:00 | ゆっくり動作 | | | |
| 2:30 | | | | |
| 3:00 | 激しく振る | | | |

#### サマリー記録
| 項目 | 値 |
|------|-----|
| IDLEのuncertainty範囲 | _____ ～ _____ |
| ACTIVEのuncertainty範囲 | _____ ～ _____ |
| UNCERTAINのuncertainty範囲 | _____ ～ _____ |
| 状態変化の反応時間 | 約 _____ 秒 |
| 誤判定回数 | _____ 回 |

### シリアルログ保存
```bash
# ターミナルでログ保存（Mac/Linux）
screen -L /dev/tty.usbserial-* 115200

# ログファイル名: imu_test_YYYYMMDD_HHMMSS.log
```

---

## 🔬 実験3: 電力測定テスト（30分）

### 手順
1. **ファームウェア書き込み**
   ```
   ファイル: firmware/m5stick/power_test/power_test.ino
   ```

2. **測定準備**
   - M5StickCをUSBから外す（バッテリー駆動）
   - バッテリー残量記録
   - シリアルモニタ準備（CSVキャプチャ）

3. **測定シーケンス**

   **A. アイドル測定（2分）**
   - 何も実行しない状態
   - 1秒ごとの電流値記録
   
   **B. 固定100ms BLE広告（5分）**
   - ble_fixed_100ms.inoに切り替え
   - 5分間連続測定
   - CSV保存
   
   **C. 固定2000ms BLE広告（5分）**
   - コード修正: `#define ADV_INTERVAL_MS 2000`
   - 再アップロード
   - 5分間連続測定
   - CSV保存

### 記録項目

#### リアルタイム記録（1分ごと）
| 経過時間 | 電圧(V) | 電流(mA) | 電力(mW) | バッテリー(%) |
|---------|---------|----------|----------|--------------|
| 0:00 | | | | |
| 1:00 | | | | |
| 2:00 | | | | |
| 3:00 | | | | |
| 4:00 | | | | |
| 5:00 | | | | |

#### 統計サマリー
| 条件 | 平均電流(mA) | 最大電流(mA) | 最小電流(mA) | 標準偏差 | 平均電力(mW) |
|------|-------------|-------------|-------------|---------|-------------|
| アイドル | | | | | |
| BLE 100ms | | | | | |
| BLE 2000ms | | | | | |

#### 削減率計算
```
削減率(%) = (I_100ms - I_2000ms) / I_100ms × 100
         = (_____ - _____) / _____ × 100
         = _____% 
```

#### バッテリー寿命推定
```
バッテリー容量: 135mAh
推定動作時間(100ms) = 135 / 平均電流_100ms = _____ 時間
推定動作時間(2000ms) = 135 / 平均電流_2000ms = _____ 時間
延長率 = _____倍
```

---

## 🔬 実験4: 統合動作テスト（30分）

### 手順
1. **統合ファームウェア作成**
   - BLE + IMU + 電力測定を統合
   - 適応制御ロジック追加（オプション）

2. **シナリオ実行**
   ```
   0:00-2:00 静止（座位）
   2:00-3:00 歩行
   3:00-4:00 静止（立位）
   4:00-5:00 階段昇降
   5:00-6:00 静止（座位）
   ```

3. **データ収集**
   - M5StickC: 状態ログ
   - スマートフォン: BLEパケットログ
   - PC: シリアル出力

### 記録項目

#### イベントログ
| 時刻 | イベント | M5状態 | BLE間隔 | 備考 |
|------|---------|--------|---------|------|
| 0:00 | 実験開始 | | | |
| 0:30 | | | | |
| 1:00 | | | | |
| 2:00 | 歩行開始 | | | |
| 2:30 | | | | |
| 3:00 | 静止（立位） | | | |
| 4:00 | 階段開始 | | | |
| 5:00 | 静止（座位） | | | |
| 6:00 | 実験終了 | | | |

#### パフォーマンス指標
| 指標 | 値 |
|------|-----|
| 状態判定精度 | ___/___（正解数/全体） |
| 平均遅延 | _____ ms |
| p95遅延 | _____ ms |
| パケット損失率 | _____% |
| 平均消費電流 | _____ mA |

---

## 📊 データ整理手順

### 1. CSVファイル作成
```csv
# power_measurement_YYYYMMDD.csv
timestamp,condition,voltage_V,current_mA,power_mW,battery_pct
1702800000,idle,3.7,5.2,19.24,95
1702800001,ble_100ms,3.7,12.5,46.25,95
...
```

### 2. 実験メタデータ
```json
{
  "experiment_id": "20241217_phase1_test",
  "device": "M5StickC_Plus2_#1",
  "firmware_version": "v0.1",
  "environment": {
    "temperature_c": 22,
    "location": "Lab",
    "interference": "minimal"
  },
  "results": {
    "power_reduction_pct": 15.3,
    "p95_latency_ms": 250,
    "accuracy_f1": 0.92
  }
}
```

### 3. グラフ作成項目
- [ ] 電流プロファイル（時系列）
- [ ] 状態遷移タイミング
- [ ] 電力削減率の棒グラフ
- [ ] 遅延分布ヒストグラム

---

## ✅ Phase 1 完了判定基準

### 必須条件
- [ ] BLE広告が100ms間隔で安定送信
- [ ] IMUで3状態（IDLE/ACTIVE/UNCERTAIN）判定可能
- [ ] 電力測定で削減率算出（目標: ≥10%）
- [ ] 5分以上の連続動作確認

### データ品質
- [ ] 各実験で最低3回測定
- [ ] CSVファイル生成完了
- [ ] 異常値の有無確認

### 次フェーズ判定
| 削減率 | 判定 | アクション |
|--------|------|-----------|
| ≥30% | 優秀 | ESP32で本実装継続 |
| 20-30% | 良好 | ESP32で改善検討 |
| 10-20% | 可 | アルゴリズム改善必要 |
| <10% | 要再考 | Nordic検討 |

---

## 📞 トラブル時の対処

### よくある問題
1. **M5StickCが認識されない**
   - USB-Cケーブル交換
   - CP2104ドライバ再インストール
   - デバイスマネージャで確認

2. **IMU値が異常**
   - M5.Imu.begin()の戻り値確認
   - I2C通信エラーチェック
   - ファームウェア再書き込み

3. **電流値が読めない**
   - バッテリー充電状態確認（>20%必要）
   - USBケーブルを外して測定
   - AXP192初期化確認

4. **BLE広告が不安定**
   - 他のBLEデバイスを遠ざける
   - WiFiルーターから離れる
   - M5StickCリセット（電源ボタン6秒長押し）

---

## 📝 実験後の作業

1. **データバックアップ**
   ```bash
   # 実験データをまとめる
   mkdir -p data/phase1/$(date +%Y%m%d)
   cp *.csv data/phase1/$(date +%Y%m%d)/
   cp *.log data/phase1/$(date +%Y%m%d)/
   ```

2. **結果記録**
   ```bash
   # quick_test.shで記録
   ./scripts/quick_test.sh
   
   # daily_logに追記
   vim docs/logs/daily_log_$(date +%Y%m%d).md
   ```

3. **次フェーズ準備**
   - 結果レビュー
   - 改善点リストアップ
   - Phase 2計画更新

---
*作成日: 2024-12-17*
*バージョン: 1.0*