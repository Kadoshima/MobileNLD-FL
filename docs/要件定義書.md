要件定義書（Version 1.0）  
プロジェクト名：Context-Uncertainty–Driven Adaptive BLE Advertising for Ultra-Low-Power Wearable HAR

0. 文書情報
- 目的：本プロジェクトにおける研究・実装・評価の要求事項を体系的に定義する
- 作成日：2025-08-17
- バージョン：1.0
- 作成者：プロジェクトチーム（責任者：あなた）
- 想定投稿先：IEICE Communications Express（ComEX）4ページレター

1. 背景・目的
1.1 背景
- ウェアラブルHARは常時センシング・通信によりエネルギー消費が高く、バッテリー寿命が制約となる。
- 多くの既存研究は推論側の省電力に注力し、通信（特にBLE広告）の省電力最適化とHAR出力の連動が不足。
1.2 目的
- HARの不確実度やコンテキストに応じてBLE広告間隔を自動適応し、通信エネルギーと検出遅延のトレードオフを最適化する。
- 実機での一貫した測定（電力・遅延・精度）により、平均40%以上の電力削減を小さな精度低下で達成し、ComEXレターにまとめる。

2. スコープ
2.1 対象範囲（実施）
- センサ側（MCU＋IMU）のオンデバイス軽量HAR推論
- 不確実度推定とBLE広告パラメータの適応制御
- スマホ側（Android）の受信・ログ収集・（任意）重推論トリガ
- 実験・評価（電力・遅延・精度・欠落率）と論文作成
2.2 非対象（今回範囲外）
- マルチデバイス協調、マルチホップ中継
- iOSバックグラウンド受信の最適化（参考値のみ）
- 長期（>1週間）運用・経年劣化の評価
- フェデレーテッド学習・個人適応の学習アルゴリズム

3. 用語定義
- HAR：Human Activity Recognition（人間活動認識）
- 不確実度：分類出力の不確実性。ここでは主にソフトマックスエントロピーまたは最大確率の反転値を用いる。
- BLE広告：非接続状態でのブロードキャスト。広告間隔Δt_advを可変制御。
- p95/p99遅延：受信遅延の95/99パーセンタイル
- 電力削減率：固定広告間隔ベースライン比での平均消費電力の相対削減

4. 利害関係者
- 研究開発担当（あなた／学生）：設計・実装・評価・論文化
- 指導教員／PI：レビュー・研究戦略
- 実験参加者：3–5名の被験者（社内・学内）
- 査読者（ComEX）：通信制御＋実測の妥当性を評価

5. 前提・制約
5.1 技術制約
- BLE Legacy Advertising（31バイト）を基本とし、Android端末で受信・ログ
- iOSはバックグラウンド受信制約が厳しいため主評価対象はAndroid
- MCUはCortex-M4F相当（例：nRF52840 DK）を想定
- IMUサンプリングは50 Hzを基本（低消費電力モード）
5.2 法規・電波
- BLE 2.4GHz ISM帯、送信出力は法令内（一般に+0〜+4 dBm以下）
- 実験は室内で実施し、第三者の識別情報を含めない

6. システム全体像
- センサ側：IMU→前処理→軽量HAR推論→不確実度算出→適応ロジック→BLE広告送信
- スマホ側：BLEスキャナ→広告受信→ログ保存（時間・RSSI・ペイロード）→（任意）重推論/通知
- 計測系：電力計（Nordic PPK2 or シャント＋オシロ）→CSVログ→解析スクリプト

7. ハードウェア要件
7.1 必須
- 開発ボード：Nordic nRF52840 DK（推奨）または nRF52832 DK
- IMU：MPU-6050, LSM6DS3 等（3軸加速度＋3軸ジャイロ）
- 計測：Nordic Power Profiler Kit II（PPK2）またはシャント抵抗10Ω＋オシロスコープ
- 電源：USB給電（PPK2経由）またはバッテリー（評価時は安定供給）
7.2 任意
- Androidスマホ（Android 10以降、BLE 5対応）
- 3Dプリントケース（装着一貫性の確保）

8. ソフトウェア要件
8.1 センサ側
- SDK：nRF5 SDK or Zephyr RTOS（いずれか）
- ランタイム：TensorFlow Lite for Microcontrollers（TFLM, int8）
- BLEスタック：SoftDevice S140（nRF52840想定）
- センサドライバ：IMU I2C/SPI
- ログ：UART経由でデバッグ可能に
8.2 スマホ側
- Androidアプリ：Kotlin/Java、BluetoothLeScanner使用
- ロギング：CSV出力（timestamp, device_id, rssi, payload_hex, recv_latency）
- 任意：重推論（端末内またはクラウド呼び出し）
8.3 解析
- Python 3.x、ライブラリ：numpy/pandas/scipy/matplotlib、scikit-learn

9. 機能要件
9.1 センシング
- IMUサンプリング：50 Hz（可変 25–100 Hz）
- 可動平均/バンドパス等の軽量前処理（CPU負荷<5%）
9.2 HAR推論
- 入力ウィンドウ：2.0秒（100サンプル）、ストライド0.5秒
- モデル：1D-CNN（パラメータ<10k, フットプリント<20KB, int8）
- 推論時間：<=5 ms（64 MHz, M4F）
9.3 不確実度推定
- 指標：ソフトマックスエントロピーHもしくは1−max_prob
- 温度スケーリングで確率校正（オフラインで温度Tを求める）
9.4 BLE広告制御
- 広告タイプ：非接続・非スキャン（ADV_NONCONN_IND）を基本
- 広告間隔Δt_adv：可変 50 ms〜2000 ms（端末・OS制約内）
- 適応更新：最大1回/2秒（レート制限）
- ヒステリシス：状態遷移に上下しきい値（例：静穏→活動で+10%マージン）
- バッテリー低下時（<10%）：安全モード（Δt_adv=5000 ms）
9.5 スマホ側ロガー
- フィルタ：Manufacturer IDで対象デバイスのみ
- 記録：受信時刻（端末時刻）、RSSI、ペイロード、連続欠落検出
- 可視化：リアルタイム受信率/遅延グラフ（簡易UI）
9.6 設定・制御IF
- UARTコマンドでしきい値・温度T・Δt_adv最小/最大・TX出力を変更可能
- 設定のRAM保存と起動時ロード

10. 非機能要件
10.1 性能目標（主）
- 平均消費電流削減：固定Δt_adv=100 msベースライン比で>=40%
- HAR精度低下：F1スコアの低下<=1.5ポイント
- p95通知遅延：<=300 ms（広告受信ベース）
- パケット欠落率：<=5%（屋内5m範囲、干渉軽微環境）
10.2 信頼性
- 長時間連続動作：>=8時間クラッシュなし
- 状態フラップ抑制：状態遷移頻度<=6回/分
10.3 可搬性・保守
- Zephyr/nRF5どちらでもビルド可能（どちらか1系統で実証必須）
- コードベースを公開可能（学術利用ライセンス）
10.4 セキュリティ・プライバシー
- 広告ペイロードに個人識別情報を含めない
- デバイスIDは短縮乱数ID（2バイト）＋セッション内のみ有効
- 活動クラスを粗カテゴリ（静穏/活動/不確実）に丸めるオプション

11. 通信仕様（BLE詳細）
11.1 広告パラメータ
- PHY：1M PHY（互換性重視）
- チャネル：37/38/39 全使用
- TXパワー：0 dBm（省電力時は-4〜-8 dBm）
- 広告間隔Δt_adv：50, 100, 200, 500, 1000, 2000 ms（段階制御）
11.2 広告データ形式（Legacy 31バイト以内）
- Flags（標準）
- Manufacturer Specific Data（推奨 12〜16バイト）
  - Company ID（2B）
  - Protocol Ver（1B）
  - Device Session ID（2B, 毎起動ランダム）
  - Activity Level（1B：0=静穏,1=活動,2=不確実）
  - Uncertainty u（1B：0–255、エントロピーを0–255で量子化）
  - Battery Level（1B：0–100%）
  - Timestamp LSB（2B：100 ms単位のモジュロ）
  - Reserved（1–4B）
11.3 接続モードのフォールバック（任意）
- 広告からスキャン要求・接続は行わない方針。実験比較用に接続間隔7.5–50 msの測定を任意で準備。

12. アルゴリズム要件
12.1 HARモデル仕様（例）
- 1D-CNN：Conv(16,k=5)→ReLU→Conv(32,k=5)→ReLU→GlobalAvgPool→FC(Classes)
- 入力：6チャネル（加速度3, ジャイロ3）、100×6
- 量子化：int8（対称/非対称いずれでも）
- メモリ：<20 KB、フラッシュ：<100 KB
12.2 不確実度算出
- エントロピーH = −Σ p_i log p_i（logは自然対数）
- 正規化不確実度 u = H / log(C)（C=クラス数, u∈[0,1]）
- 代替：1−max(p_i) も選択可能（設定で切替）
12.3 適応ロジック（状態機械）
- EWMA：m_t = α·u_t + (1−α)·m_{t−1}（α=0.2推奨）
- 状態：Quiet/Active/Uncertainの3状態
  - Quietエントリ条件：m_t < θ_q_in（例 0.25）かつ活動スコア低
  - Activeエントリ条件：m_t > θ_a_in（例 0.60）
  - Uncertain：上記以外
- 状態ごとのΔt_adv：
  - Quiet：2000 ms
  - Uncertain：500 ms
  - Active：100 ms（端末により50 ms可）
- ヒステリシス：
  - Quiet維持条件：m_t < θ_q_out（例 0.30）
  - Active維持条件：m_t > θ_a_out（例 0.55）
- レート制限：前回変更から2秒未満は変更しない
- バッテリーセーフガード：battery<10% → Δt_adv=5000 ms固定
12.4 しきい値キャリブレーション
- 検証データで温度Tを最適化（NLL最小）
- ROC/PRを見てθ_q_in/θ_a_inをグリッド探索（Δ=0.05）
- 目標：活動検出リコール>=95%かつ平均Δt_adv最大

13. データ要件
13.1 収集
- 被験者：3–5名
- シナリオ：静坐30分、歩行30分、デスクワーク60分、階段/家事30分、休憩30分（合計~3時間/人）
- ラベル：粗カテゴリ（静穏/活動）＋時刻同期はスマホログ基準
13.2 保存
- センサ側：必要に応じてウィンドウ毎にUARTダンプ（開発時のみ）
- スマホ側CSV：timestamp(ms), dev_session_id, rssi(dBm), payload_hex, seq_no
- 計測CSV：time(s), current(mA), voltage(V)

14. 測定・評価要件（実験計画）
14.1 指標定義
- 平均消費電流 I_avg [µA]：PPK2測定の平均
- エネルギー/分 E_min [mJ/min]：I_avg×V×60s
- HAR F1：マクロF1、粗カテゴリ
- 遅延：広告生成時刻（推定）→受信記録の差分。広告周期から下限を推定しp50/p95を算出
- 欠落率：生成推定パケット数に対する受信数の不足割合
14.2 ベースライン
- 固定広告間隔：100 ms、200 ms、500 ms
- 固定サンプリング・固定推論頻度（本提案同）
14.3 実験条件
- 環境：屋内オフィス、距離2–5m、干渉中程度
- 端末：Android Pixel系1台、追加で別Android1台（再現性）
- 計測期間：各設定15分×条件（合計>=3時間/人）
14.4 手順
- 校正：温度スケーリング→しきい値探索（開発者1名・室内）
- 本番測定：被験者着用、タスクスケジュールに沿って移動・作業
- PPK2：ターゲット電源供給＋サンプリング10 kHz、CSV保存
- スマホ：バックグラウンドスキャン有効、ログ保存
14.5 解析・統計
- ペア比較（提案vs固定100ms）：被験者ごとに平均差と95%CI
- 有意性：対応のあるt検定（α=0.05）
- パレート曲線：エネルギー-遅延-精度の3軸で可視化

15. ログ・監視・テレメトリ要件
- センサ側：状態遷移、Δt_adv、u、電池残量を1分ごとにUART出力（開発時のみ）
- スマホ側：受信間隔ヒストグラム、RSSI時系列、セッション要約
- 計測：イベントマーカー（状態遷移時にGPIOトグル→オシロ/PPK2で同期）

16. UX/操作要件
- スマホアプリに開始/停止、フィルタ設定、簡易グラフ表示
- UARTコマンドで全設定の一覧・変更・保存
- LED表示：状態（静穏=緑点滅、活動=赤点滅、不確実=黄点滅）[開発時のみ]

17. リスク・対応策
- Androidスキャン制限：バックグラウンドでのスキャン間隔が伸びる → フォアグラウンドサービス化、ロックスクリーン通知維持
- iOS受信制約：主評価から除外、参考測定のみ。Δt_adv<100msは受信低下 → iOS時は200–1000 msのみ
- 混雑環境での衝突：TX出力調整、チャネルマップはデフォルト、実験は周波数干渉の少ない時間帯を選択
- 電力測定誤差：PPK2＋シャント/オシロの二重計測で整合性確認
- 過適応（フラッピング）：ヒステリシス・レート制限・EWMAで抑制

18. 法令・規格準拠
- BLE SIG規格に準拠（GAP/GATT。今回はGATT非使用）
- 電波法準拠（出力制限内）
- 倫理：被験者の同意取得、個人情報不収集、活動推定の匿名化

19. スケジュール・マイルストーン（目安6週間）
- W1：環境構築（SDK/TFLM/IMU/BLE）、固定広告送信動作
- W2：HARモデル実装・量子化・推論計測
- W3：不確実度計算・適応ロジック実装・設定IF
- W4：計測系準備（PPK2/ログ）、校正・しきい値探索
- W5：被験者実験・データ収集・解析
- W6：論文執筆・図表作成・内部レビュー・投稿

20. 成果物
- センサ側ファームウェア（ソースコード、ビルド手順）
- Androidロガーアプリ（APK/ソース）
- 測定スクリプト（Python）と再現用ノートブック
- データパッケージ（匿名化CSV、README）
- 論文原稿（4ページ、図1–3、表1）

21. 受け入れ基準（合格条件）
- 平均消費電流削減率>=40%（固定100 ms比）、かつ統計的有意性あり（p<0.05）
- F1低下<=1.5ポイント（同一データ・プロトコル）
- p95遅延<=300 ms、欠落率<=5%
- 8時間連続動作でハング/クラッシュなし
- コード・データ・手順の再現パッケージが整備済み

22. 変更管理・トレーサビリティ
- 要件→設計→実装→テストケースの一対一トレーサビリティ表を作成（スプレッドシート）
- 変更はIssueベースで管理し、影響範囲と承認者を明記

23. 将来拡張（次期）
- 拡張広告（Extended Advertising, >31B）とセカンダリPHYの活用
- マルチデバイス協調（スマホ→スマートウォッチ→クラウド）
- 個人適応（夜間充電時の軽量蒸留）
- エネルギーハーベスティングを前提にしたスケジューリング
- iOS向け最適化とバックグラウンド制約回避の検討

24. 付記：推奨パラメータの初期値
- サンプリング周波数：50 Hz
- ウィンドウ/ストライド：2.0s / 0.5s
- Δt_advセット：{100, 500, 2000} ms（最小構成）
- しきい値：θ_q_in=0.25, θ_q_out=0.30, θ_a_out=0.55, θ_a_in=0.60
- EWMA係数：α=0.2
- TX出力：0 dBm（Quiet時は-4 dBm）
- レート制限：2秒

25. 参考ベンチマーク式（設計時の見積）
- 総消費電力 E_total ≈ E_comp（HAR推論・前処理） + E_adv（送信）
- E_adv ≈ N_tx_per_min × E_per_adv（送信1回あたりのエネルギー）
- 目標はN_tx_per_minの自適応削減によりE_advを支配的に低減

以上。  
不足があれば、実験手順書とCSVスキーマ定義、UARTコマンド仕様を掘り下げて追補します。