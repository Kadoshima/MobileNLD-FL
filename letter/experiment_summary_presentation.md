# ピボット実験内容サマリー

## 研究タイトル
**Context-Uncertainty-Driven Adaptive BLE Advertising for Ultra-Low-Power Wearable HAR**
（文脈不確実度駆動型適応的BLE広告によるウェアラブルHARの超低消費電力化）

## 1. 研究概要

### 目的
- HAR（人間活動認識）の不確実度に基づくBLE広告間隔の動的制御
- ウェアラブルデバイスの大幅な省電力化（30-40%削減目標）

### キーイノベーション
1. **適応的BLE広告**: 100ms～2000msの動的調整
2. **非接続型広告**: ADV_NONCONN_INDで接続オーバーヘッド回避
3. **複合コンテキストスコア**: 分類不確実度＋時間的変動性
4. **実機検証**: M5StickC Plus2での実装と電力測定

## 2. システム構成

### ハードウェア
```
[M5StickC Plus2] - ウェアラブルデバイス
├─ ESP32-PICO-V3-02 MCU (520KB RAM)
├─ MPU6886 6軸IMU（内蔵）
├─ AXP192 電力管理IC
├─ 135mAhバッテリー
├─ オンデバイスHAR推論
├─ 不確実度計算
└─ 適応的BLE広告

[スマートフォン] - 受信機＆ロガー
├─ BLEパケット受信
├─ タイムスタンプ記録
├─ CSVエクスポート
└─ リアルタイム監視
```

### 利用可能機材
- M5StickC Plus2: 3台
- iPhone: 13, 15
- Android: Galaxy S9
- PPK2: なし（AXP192で代替、精度±5mA）

## 3. 実験プロトコル

### 3.1 実験条件
| 条件 | BLE広告間隔 | 説明 |
|------|------------|------|
| ベースライン1 | Fixed-100ms | 従来方式（高頻度） |
| ベースライン2 | Fixed-200ms | 中間頻度 |
| ベースライン3 | Fixed-500ms | 低頻度 |
| 提案手法 | Adaptive | 100-2000ms動的制御 |

### 3.2 制御状態（3状態機械）
制御状態はHAR分類結果（IDLE/ACTIVE/UNCERTAIN）と不確実度の組み合わせで決定：

#### HAR状態（3種類）
1. **IDLE**: 静止状態（加速度分散 < 0.15）
2. **ACTIVE**: 活動状態（加速度分散 ≥ 0.15）
3. **UNCERTAIN**: 不確実状態（分類境界付近）

#### 制御状態マッピング
| 制御状態 | 広告間隔 | HAR状態 | 不確実度 | 消費電流（推定） |
|---------|---------|---------|----------|----------------|
| QUIET | 2000ms | IDLE | 任意 | 20.1mA |
| QUIET | 2000ms | UNCERTAIN | 低（< 0.25） | 20.1mA |
| UNCERTAIN | 500ms | UNCERTAIN | 中（0.3-0.6） | 20.4mA |
| UNCERTAIN | 500ms | ACTIVE | 低（< 0.6） | 20.4mA |
| ACTIVE | 100ms | UNCERTAIN | 高（≥ 0.6） | 22.0mA |
| ACTIVE | 100ms | ACTIVE | 高（≥ 0.6） | 22.0mA |

**制御ルール**：
1. **IDLE状態**: 常にQUIET（2000ms）で省電力
2. **UNCERTAIN状態**: 不確実度に応じて適応
3. **ACTIVE状態**: 不確実度高い時のみ高頻度（100ms）

### 3.3 閾値パラメータ
```
θ_q_in = 0.3   # QUIET状態への遷移閾値
θ_q_out = 0.2  # QUIET状態からの脱出閾値
θ_a_in = 0.7   # ACTIVE状態への遷移閾値
θ_a_out = 0.6  # ACTIVE状態からの脱出閾値
```

## 4. 実験手順

### 4.1 事前準備チェックリスト
- [ ] NTP時刻同期（PC＆Android）
- [ ] Run ID生成（scripts/new_run.sh）
- [ ] メタデータテンプレート作成
- [ ] FW/Appコミット記録
- [ ] PPK2キャリブレーション（AXP192代替時はスキップ）
- [ ] Android位置情報権限ON
- [ ] SYNC系列準備（3秒、LED×3）

### 4.2 実験中
1. **同期**: 3秒間のLED点滅でデバイス間同期
2. **測定時間**: 各条件15分間
3. **同時測定**: PPK2 + スマホ + UART
4. **活動内容**:
   - 座位: 30分
   - 歩行: 30分
   - デスクワーク: 60分
   - 階段/家事: 30分
   - 休憩: 30分

### 4.3 実験後（5分以内）
- [ ] data/raw/YYYYMMDD/に保存
- [ ] SHA256チェックサム生成
- [ ] マニフェスト作成
- [ ] raw/をREAD-ONLYに設定
- [ ] 軽量QC（パケットロス<10%）
- [ ] catalog.csv更新
- [ ] クラウド/外部バックアップ

## 5. 評価指標（優先順位）

### 5.1 一次指標
1. **平均消費電流削減率**: ≥30-40%（固定100ms比）
   - AXP192@1Hz測定（精度±5mA）
   - I_avg[µA]、E_min[mJ/min]、バッテリー寿命推定

2. **p95通知遅延**: ≤300ms（広告受信ベース）
   - Androidログからパケット受信間隔
   - p50/p95パーセンタイル計算

### 5.2 二次指標
3. **HAR F1スコア**: 劣化≤1.5ポイント
   - 粗カテゴリ（Quiet/Active）のマクロF1

4. **パケットロス率**: ≤5%（屋内5m範囲）

## 6. データ管理（厳格）

### 6.1 命名規則
```
subject_id:  S[0-9]{2}              (例: S01)
device_id:   [A-Za-z0-9_-]{1,16}    (例: devA01)
condition:   Fixed-100ms|Fixed-200ms|Fixed-500ms|Adaptive
run_id:      YYYYMMDD_HHMMSSZ_{subject}_{condition}_{seq3}
             (例: 20250901_043015Z_S01_Adaptive_001)
filename:    {type}_{run_id}.{ext}  (ppk2_*, phone_*, uart_*, meta_*)
```

### 6.2 ディレクトリ構造
```
data/
├── raw/                    # 🔒 保存後READ-ONLY
│   └── YYYYMMDD/          # 日付フォルダ
│       └── subject_id/    # 被験者フォルダ
│           └── condition/ # 条件フォルダ
│               ├── ppk2_*.csv
│               ├── phone_*.csv
│               ├── uart_*.log
│               ├── meta_*.json
│               └── manifest_*.txt
├── processed/             # 中間ファイル
└── releases/              # 論文提出スナップショット
```

## 7. 実施済み成果

### 7.1 実装完了
- ✅ M5StickC Plus2ファームウェア（2クラスHAR）
- ✅ 不確実度計算アルゴリズム
- ✅ 3状態適応制御実装
- ✅ 固定値による電力推定（AXP192なしのため）

### 7.2 初期実験結果
- **パケット削減率**: 81.4%達成
- **電力削減率**: 7.8%（推定値）
- **状態分布**: QUIET 87.3%、UNCERTAIN 4.4%、ACTIVE 8.3%

## 8. タイムライン（6週間スプリント）

| 週 | タスク | 状態 |
|----|--------|------|
| Week 1 | 環境構築・固定BLE広告 | ✅ |
| Week 2 | HARモデル実装・量子化 | ✅ |
| Week 3 | 適応制御実装 | ✅ |
| Week 4 | 測定システム準備 | ✅ |
| Week 5 | 被験者実験（3-5名） | 🔄 |
| Week 6 | 解析・論文執筆 | 📝 |

## 9. 成功基準

### 技術目標
- ✅ 平均電流削減≥30%（統計的有意差p<0.05）
- ✅ p95遅延≤300ms
- ✅ パケットロス率≤5%
- ✅ F1スコア劣化≤1.5ポイント
- ✅ 1時間連続動作（ハング/クラッシュなし）
- ✅ TFLite Microモデル<20KB（int8量子化）

### 研究目標
- ✅ 新規性：不確実度駆動型適応
- ✅ 実世界電力測定
- ✅ 統計的検証
- ✅ 再現可能な実装

## 10. 注意事項

### 禁止事項
❌ 生データの上書き・削除
❌ タイムゾーン混在（UTCのみ使用）
❌ UARTログなしの設定変更
❌ カスタム命名規則
❌ 非再現性結果の提出
❌ チェックサム・マニフェストのスキップ

### インシデント報告
SOPからの逸脱時は必須：
1. `docs/incidents/YYYYMMDD_incident.md`作成
2. meta.posthoc_patchに記録
3. GitHubイシューに`incident`ラベル

---
*プロジェクトステータス: アクティブ開発中*
*最終更新: 2024-12-17*
*ターゲット: IEICE ComEX (2025)*
*ガバナンス: 厳格なAPPEND-ONLYデータポリシー*