# BLE適応制御 電力シミュレーション設計書

## 1. シミュレーション概要

M5StickC Plus2デバイスでBLE広告を行う際の消費電力を、固定間隔方式と適応制御方式で比較するシミュレーション。

## 2. ハードウェア仕様

### デバイス: M5StickC Plus2
- MCU: ESP32-PICO-V3-02
- バッテリー: 135mAh (3.7V)
- BLE: Bluetooth 4.2 / BLE
- 電源管理: GPIO制御（AXP192なし）

## 3. 電力消費モデル

### 3.1 基本消費電流（固定値推定）

| コンポーネント | 消費電流 |
|--------------|---------|
| MCU (アイドル) | 10 mA |
| ディスプレイ | 5 mA |
| IMU (MPU6886) | 3 mA |
| BLE (アイドル) | 2 mA |
| **基本消費計** | **20 mA** |

### 3.2 BLE広告時の追加消費電流

| 動作 | 追加電流 | 持続時間 |
|------|---------|---------|
| BLE広告送信 | +20 mA | 10 ms/回 |

### 3.3 制御状態別の総消費電流

| 制御状態 | 広告間隔 | 平均電流計算式 | 推定平均電流 |
|---------|---------|--------------|------------|
| QUIET | 2000ms | 20 + (20 × 10/2000) | 20.1 mA |
| UNCERTAIN | 500ms | 20 + (20 × 10/500) | 20.4 mA |
| ACTIVE | 100ms | 20 + (20 × 10/100) | 22.0 mA |

## 4. 活動パターンモデル

### 4.1 典型的な1日の活動分布（8時間）

| 活動 | 時間 | 割合 | HAR状態 |
|------|-----|------|--------|
| 睡眠/静止 | 2時間 | 25% | IDLE |
| デスクワーク | 4時間 | 50% | IDLE/UNCERTAIN |
| 歩行/活動 | 1.5時間 | 18.75% | ACTIVE |
| その他 | 0.5時間 | 6.25% | UNCERTAIN |

### 4.2 制御状態の時間配分（実験データより）

#### 固定100ms方式
- 全時間: ACTIVE状態（100ms間隔）
- 平均電流: 22.0 mA（一定）

#### 適応制御方式（実験結果より）
- QUIET (2000ms): 87.3%
- UNCERTAIN (500ms): 4.4%
- ACTIVE (100ms): 8.3%

## 5. シミュレーション計算

### 5.1 平均消費電流

#### 固定100ms方式
```
I_avg = 22.0 mA（一定）
```

#### 適応制御方式
```
I_avg = 0.873 × 20.1 + 0.044 × 20.4 + 0.083 × 22.0
      = 17.55 + 0.90 + 1.83
      = 20.28 mA
```

### 5.2 電力削減率
```
削減率 = (22.0 - 20.28) / 22.0 × 100
       = 7.8%
```

### 5.3 バッテリー持続時間

#### 固定100ms方式
```
持続時間 = 135 mAh / 22.0 mA = 6.14 時間
```

#### 適応制御方式
```
持続時間 = 135 mAh / 20.28 mA = 6.66 時間
```

### 5.4 持続時間改善率
```
改善率 = (6.66 - 6.14) / 6.14 × 100 = 8.5%
```

## 6. シミュレーションパラメータ

### 6.1 調整可能パラメータ
1. **基本消費電流**: 15-25 mA（デバイス設定による）
2. **BLE広告電流**: 15-25 mA（送信電力による）
3. **広告持続時間**: 5-15 ms（パケットサイズによる）
4. **活動パターン**: 実測データまたはモデル化

### 6.2 感度分析項目
1. 基本消費電流の影響
2. BLE広告電流の影響
3. 活動パターンの影響
4. 制御閾値の最適化

## 7. 実装要件

### 7.1 入力データ
- 制御状態の時間配分（CSV形式）
- デバイスパラメータ（JSON形式）

### 7.2 出力データ
- 時系列電流プロファイル
- 統計サマリー（平均電流、削減率など）
- グラフ（電流推移、累積消費電力など）

### 7.3 シミュレーション手法
1. **離散イベントシミュレーション**: 状態遷移ベース
2. **モンテカルロ法**: 活動パターンの確率的生成
3. **時系列分析**: 実測データの再現

## 8. 検証方法

### 8.1 実測との比較
- バッテリー残量の時間推移
- 実際の動作時間との照合

### 8.2 妥当性確認
- 物理的制約（最小/最大電流）
- エネルギー保存則

## 9. 拡張可能性

### 9.1 より詳細なモデル
- 温度依存性
- バッテリー電圧降下の影響
- CPU負荷による変動

### 9.2 最適化
- 閾値パラメータの自動調整
- 活動予測による先行制御

## 10. 参考値

### ESP32の典型的な消費電流
- Deep Sleep: 0.01 mA
- Light Sleep: 0.8 mA
- Modem Sleep: 20 mA
- Active (WiFi off): 40-50 mA
- BLE advertising: 60-100 mA（ピーク）

### 注意事項
- 実際の消費電流は温度、電圧、個体差により変動
- 本設計書の値は推定値であり、実測による検証が必要